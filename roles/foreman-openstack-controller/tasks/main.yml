---
- name: Make /etc/hosts proper
  lineinfile: dest=/etc/hosts regexp='.*{{item}}$' line='${hostvars.${item}.ansible_eth1.ipv4.address} ${item}' state=present
  with_items: '{{groups.foreman}}'

- name: Make /etc/hosts proper with controller
  lineinfile: dest=/etc/hosts regexp='.*{{item}}$' line='${hostvars.${item}.ansible_eth1.ipv4.address} ${item}' state=present
  with_items: '{{groups.controller}}'

- name: Get the client installer
  get_url: url=https://foreman.example.com/foreman_client.sh dest=/tmp/foreman_client.sh mode=0755 force=yes

- name: Register this host with foreman
  action: shell /tmp/foreman_client.sh
        creates=/var/lib/puppet/ssl/certs/{{ inventory_hostname }}.pem

- name: Get OpenStack Neutron Controller hostgroup
  action: >
        uri url=https://foreman.example.com/api/hostgroups?search=name=\"OpenStack+Neutron+Controller\"
        method=GET
        user=admin
        password=changeme
        force_basic_auth=yes
        return_content=yes
        HEADER_Content-Type="application/json"
        HEADER_Accepts="application/json"
  register: hostgroup_json

- name: Get the host back from foreman
  action: >
        uri url=https://foreman.example.com/api/hosts?search=name=\"{{ inventory_hostname }}\"
        method=GET
        user=admin
        password=changeme
        force_basic_auth=yes
        return_content=yes
        HEADER_Content-Type="application/json"
        HEADER_Accepts="application/json"
  register: host_json

- name: Set the hostgroup
  action: >
        uri url=https://foreman.example.com/api/hosts/{{host_json.json[0].host.id}}
        body='{"host": {"id": "{{ host_json.json[0].host.id }}", "hostgroup_id": "{{ hostgroup_json.json[0].hostgroup.id }}"}}'
        method=PUT
        user=admin
        password=changeme
        force_basic_auth=yes
        return_content=yes
        HEADER_Content-Type="application/json"
        HEADER_Accepts="application/json"

- name: Apply OpenStack Neutron Controller from puppet
  action: command /usr/bin/puppet --onetime --verbose --ignorecache --no-daemonize --no-usecacheonfailure --no-splay --show_diff
