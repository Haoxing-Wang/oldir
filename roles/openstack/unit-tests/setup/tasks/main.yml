---
- name: print variables used in role
  debug: var=component.dir
- debug: var=ansible_env.HOME

- name: compute the directory basename
  set_fact: component_basename={{component.dir.split('/')|last}}

- name: find the test dependencies file used for the test-run
  set_fact: test_deps_file="{{ component.dir + '/jenkins-config.yml'}}"

- name: print the test dependencies filename
  debug: msg="Going to install rpms listed in {{ test_deps_file.split('/') | last }}"
#"

- name: load test config file
  include_vars: "{{test_deps_file}}"

- debug: msg="going to setup env based on {{test.env_name}}"

- name: set test config variables
  include_vars: test_config.yml


- name: create additional repos if specified
  sudo: yes
  template: src=repo.j2
            dest=/etc/yum.repos.d/{{item.filename}}
  with_items: test_env.setup.repos
  when: test_env.setup.repos | default(false)

- name: install default set of package needed to run tests
  sudo: yes
  yum: pkg={{item}} state=latest
  with_items:
      - which
      - python-junitxml
      - python-virtualenv

- name: install test dependencies rpm needed to run test
  sudo: yes
  yum: pkg={{item}} state=latest
  with_items: test_env.setup.install
  when: test_env.setup.install | default(false)

- name: remove unwanted rpms specified in test dependencies
  sudo: yes
  yum: pkg={{item}} state=absent
  with_items: test_env.setup.remove
  when: test_env.setup.remove | default(false)

- name: remove virtualenv used for running tests if already present
  file: path={{ansible_env.HOME}}/testbed/venv state=absent


- name: create a virtualenv for overridding system-site-packages
  pip: name={{item}} virtualenv=~/testbed/venv virtualenv_site_packages=yes
  with_items: test_env.setup.pip.overrides
  when:
    test_env.setup.pip | default(false) and
    test_env.setup.pip.overrides | default(false)

- name: copy git repo to testbed vm
  synchronize:
      src='{{component.dir}}'
      dest="{{ansible_env.HOME}}/testbed"
  register: result

- name: compute the testbed path
  set_fact:
    component_path={{ansible_env.HOME + '/testbed/' + component_basename }}
