- name: Remove old testrun dirs if present
  file: path="{{ansible_env.HOME}}/testbed/{{item}}" state=absent
  with_items:
  - logs/
  - "{{component_basename}}/.testrepository/"
  - "{{component_basename}}/.venv/"

- name: Create new logs dir
  file: path={{ansible_env.HOME}}/testbed/logs/ state=directory
      #python -m nova.openstack.common.lockutils testr run --parallel --subunit

- name: Run test using only installed packages
  shell: >
      source ~/testbed/venv/bin/activate;
      find . -iname '*.pyc' -type f -delete;
      testr init;
      python -m nova.openstack.common.lockutils python setup.py testr --testr-args='--subunit --concurrency 0  '
      | subunit2junitxml --output-to=../logs/testresult.xml -f
      | subunit-2to1 | tools/colorizer.py >../logs/testrun.log 2>&1
  args:
      chdir: testbed/{{component_basename}}
      executable: /bin/bash
  register: test_run
  ignore_errors: yes

- name: copy test results to logs dir
  fetch: src={{ansible_env.HOME}}/testbed/logs/{{item}}
         dest=../../logs/ flat=yes
  with_items:
      - testresult.xml
      - testrun.log

