---
- name: create instance
  nova_compute:
    name: "{{ inventory_hostname }}"
    auth_url: "{{ openstack_auth_url }}"
    flavor_id: 2
    image_id: "{{ openstack_image_id }}"
    key_name: "{{ openstack_key_name }}"
    login_username: "{{ openstack_login_username }}"
    login_password: "{{ openstack_login_password }}"
    login_tenant_name: "{{ openstack_login_tenant_name }}"
    nics:
      - net-id: 3721f603-3234-4c14-b8c7-e230f592eb15
      - net-id: 56871378-b6b9-4c41-b2ad-a976d1515793
      - net-id: 839eaacf-e834-4dd3-b7c5-04e90fcc5bfa
    region_name: "{{ openstack_region_name }}"
    security_groups: default
    wait_for: 500
  register: nova

- name: assign floating ip to instance
  when: floating_ip is defined
  quantum_floating_ip:
    auth_url: "{{ openstack_auth_url }}"
    instance_name: "{{ inventory_hostname }}"
    login_username: "{{ openstack_login_username }}"
    login_password: "{{ openstack_login_password }}"
    login_tenant_name: "{{ openstack_login_tenant_name }}"
    network_name: default
    region_name: "{{ openstack_region_name }}"

- name: add instance with ssh ip
  add_host: hostname={{ inventory_hostname }}_real ansible_ssh_host={{ item }} groups={{ group_names[0] }}_real
  with_items: nova.private_ip

- name: wait for instance to boot
  wait_for:
    host: "{{ item }}"
    port: 22
  with_items: nova.private_ip