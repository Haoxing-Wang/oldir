---
- name: ensure rhos-release is disabled
  shell: "rhos-release  -x {{ product.version|int }}; "
  sudo: yes
  ignore_errors: yes

- name: ensure release rpms are removed
  yum: name={{item }} state=absent
  sudo: yes
  with_items:
    - rhos-release
    - rdo-release
    - epel-release

- name: ensure yum repos metadata and cache are clean
  sudo: yes
  shell: >
    yum clean all;
    rm -Rf /var/cache/yum;
    rm -Rf /etc/yum.repos.d/*.repo

- name: get instack-setup-host script if it doesn't exist
  get_url: url=https://raw.githubusercontent.com/rdo-management/instack-undercloud/master/scripts/instack-setup-host
                  dest=/usr/bin/instack-setup-host mode=0755
  sudo: yes

- name: run instack-setup-host script
  shell: export RUN_RHOS_RELEASE=1; instack-setup-host

- name: get the guest-image
  shell: >
    curl -o /home/stack/{{ distro.images[distro.name][ansible_distribution_version].guest_image_name }} \
    "{{ distro.images[distro.name][ansible_distribution_version].remote_file_server }}{{ distro.images[distro.name][ansible_distribution_version].guest_image_name }}"

- name: install instack-undercloud
  yum: name=instack-undercloud state=present
  sudo: yes
  when: "\"rdo-management/instack-undercloud\" != \"{{ lookup('env', 'GERRIT_PROJECT') }}\""
