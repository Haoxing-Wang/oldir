---
- name: ensure release rpms are removed
  yum: name={{item }} state=absent
  sudo: yes
  with_items:
    - rhos-release
    - rdo-release
    - epel-release

- name: remove any yum repos before the setup host script
  shell: rm -Rf /etc/yum.repos.d/*.repo
  sudo: yes

- name: get instack-setup-host script if it doesn't exist
  get_url: url=https://raw.githubusercontent.com/rdo-management/instack-undercloud/master/scripts/instack-setup-host
                  dest=/usr/bin/instack-setup-host mode=0755
  sudo: yes

- name: run instack-setup-host script
  shell: instack-setup-host

- name: get the guest-image
  get_url: url={{ distro.images[distro.name][ansible_distribution_version].remote_file_server }}{{ distro.images[distro.name][ansible_distribution_version].guest_image_name }}
                dest={{ instack_user_home }}

- name: install instack-undercloud
  yum: name=instack-undercloud state=present
  sudo: yes
  when: "\"rdo-management/instack-undercloud\" != \"{{ lookup('env', 'GERRIT_PROJECT') }}\""
