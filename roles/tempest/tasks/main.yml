---
- { include: setup-tempest.yml tags=tempest_setup }

# tempest pip install requirements will fail w/o these reqs
- name: Ensure libffi-devel, openssl-devel rpms installed
  yum: name={{ item }} state=latest
  with_items:
    - libffi-devel
    - openssl-devel
  tags:
    - prep

- name: pip install junitxml, unittest2, testtools
  pip: name={{ item }} virtualenv=/var/lib/tempest/.venv
  with_items:
    - junitxml
    - unittest2
  tags:
    - tempest_setup

- name: pip install testtools, specific version
  pip: name={{ item.name }} version={{ item.version }} virtualenv=/var/lib/tempest/.venv
  with_items:
    - { name: testtools, version: '0.9.34' }
    - { name: python-subunit, version: '0.0.15'}
  tags:
    - tempest_setup


- name: pip install requirements
  pip: requirements=/var/lib/tempest/requirements.txt virtualenv=/var/lib/tempest/.venv
  tags:
    - tempest_setup

- name: remove /var/lib/tempest/.testrepository
  file: path=/var/lib/tempest/.testrepository state=absent
  tags:
    - tempest_run

- name: Run tempest
  script: run_tempest.sh {{ tempest['checkout_dir'] }} {{ tempest['test_name'] }}
       --exclude-files {{ tempest['exclude']['files'] }}
       --exclude-tests {{ tempest['exclude']['tests'] }}
  tags:
    - tempest_run

- name: Fetch results
  fetch: src={{ tempest['checkout_dir']}}/nosetests.xml dest=nosetests.xml flat=yes
  tags:
    - tempest_run
