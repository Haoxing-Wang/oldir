---

- name: check that you can connect (GET) - returns a status 200
  action: uri url="https://{{ staypuft.deploy.ip }}"
  register: webpage

- name: login to the webpage and save cookie
  uri: url="https://{{ staypuft.deploy.ip }}/users/login"
       method=POST
       body="login[login]={{ staypuft.deploy.login.username }}&login[password]={{ staypuft.deploy.login.password }}"
       follow_redirects=safe
       HEADER_Content-Type="application/x-www-form-urlencoded"
       status_code=302
       return_content=yes
  register: login

- name: use get command to return authenticity_token
  uri: url="https://{{ staypuft.deploy.ip }}"
       method=GET
       HEADER_Cookie="{{login.set_cookie}}"
       status_code=200
       follow_redirects=safe
       return_content=yes
  register: get_output

- name: find the authenticity_token
  shell: >
     sed -n "s/&lt;meta content=&#34;\(.*\)&#34; name=&#34;csrf-token&#34; \/&gt;/\1/;t end;b;:end;p;q" <<<'{{ get_output.content|escape }}'
  register: token

- name: create a new deployment
  uri: url="https://{{ staypuft.deploy.ip }}/deployments/new"
       HEADER_Cookie="{{login.set_cookie}}"
       method=GET
  register: new_deployment

- name: get deployment id number
  shell: sed -n 's/https:\/\/{{ staypuft.deploy.ip }}\/deployments\/\(.*\)\/steps\/deployment_settings?/\1/p' <<<"{{ new_deployment.content_location }}"
  register: deployment_id

- name: add deployment settings
  uri: url="https://{{ staypuft.deploy.ip }}/deployments/{{ deployment_id.stdout }}/steps/deployment_settings"
       method=PUT
       HEADER_Cookie="{{login.set_cookie}}"
       HEADER_X-CSRF-Token="{{ token.stdout }}"
       HEADER_Content-Type="application/json"
       body='{"staypuft_deployment":{"name":"{{ staypuft.deploy.deployment_settings.name }}{{ 10000 |random }}","description":"{{ staypuft.deploy.deployment_settings.description }}","layout_name":"{{ staypuft.deploy.deployment_settings.layout_name }}","networking":"{{ staypuft.deploy.deployment_settings.networking }}","amqp_provider":"{{ staypuft.deploy.deployment_settings.amqp_provider }}","platform":"{{ staypuft.deploy.deployment_settings.platform }}","passwords":{"mode":"single","single_password":"{{ staypuft.deploy.deployment_settings.single_password }}","single_password_confirmation":"{{ staypuft.deploy.deployment_settings.single_password_confirmation }}"}}}'
       follow_redirects=safe
       status_code=302

- name: add services configuration
  uri: url="https://{{ staypuft.deploy.ip }}/deployments/{{ deployment_id.stdout }}/steps/services_configuration"
       method=PUT
       HEADER_Cookie="{{login.set_cookie}}"
       HEADER_X-CSRF-Token="{{ token.stdout }}"
       HEADER_Content-Type="application/json"
       body='{"staypuft_deployment":{"neutron":{"network_segmentation":"{{ staypuft.deploy.services_configuration.neutron.network_segmentation }}"},"glance":{"driver_backend":"{{ staypuft.deploy.services_configuration.glance.driver_backend }}"},"cinder":{"backend_nfs":"{{ staypuft.deploy.services_configuration.cinder.backend_nfs }}","nfs_uri":"{{ staypuft.deploy.services_configuration.cinder.nfs_uri }}"}}}'
       follow_redirects=safe
       status_code=302

- name: find hostgroup_id groups
  uri: url="https://{{ staypuft.deploy.ip }}/deployments/{{ deployment_id.stdout }}#controller_neutron_free_hosts"
       method=GET
       HEADER_Cookie="{{login.set_cookie}}"
       HEADER_X-CSRF-Token="{{ token.stdout }}"
       return_content=yes
       follow_redirects=safe
  register: controller_content

- name: return hostgroup_id numbers
  shell: >
    sed -n 's/&lt;input id=&#34;hostgroup_id&#34; name=&#34;hostgroup_id&#34; type=&#34;hidden&#34; value=&#34;\(.*\)&#34; \/&gt;/\1/p' <<<"{{ controller_content.content|escape|truncate(96210) }}"
  register: hostgroup_ids

- name: return host_id numbers
  uri: url="https://{{ staypuft.deploy.ip }}/api/v2/discovered_hosts"
       method=GET HEADER_Cookie="{{login.set_cookie}}"
       HEADER_Content-Type="application/json"
       HEADER_Accepts="application/json"
       return_content=yes
  register: discovered_hosts

- name: associate host
  uri: url="https://{{ staypuft.deploy.ip }}/deployments/{{ deployment_id.stdout }}/associate_host"
       method=POST
       HEADER_Cookie="{{login.set_cookie}}"
       HEADER_X-CSRF-Token="{{ token.stdout }}"
       HEADER_Content-Type="application/json"
       body='{"hostgroup_id":"{{ hostgroup_ids.stdout.split()[item|int] }}","host_ids":"{{ discovered_hosts.json.results[item|int].id}}"}'
       follow_redirects=safe
       status_code=302
  with_sequence: start="{{ staypuft.deploy.start_node }}" end="{{ staypuft.deploy.end_node }}"

- name: get deployment configuration file to import
  template: src={{ staypuft.deploy.deployment_config }}.j2 dest=/tmp/{{ staypuft.deploy.deployment_config }}

- name: import deployment config file
  shell: >
    curl -k -X POST -b "{{login.set_cookie}}" -H X-CSRF-Token:"{{ token.stdout }}" --form "deployment_config_file=@/tmp/{{ staypuft.deploy.deployment_config  }}" https://{{ staypuft.deploy.ip }}/deployments/{{ deployment_id.stdout }}/import_config -vvv

- name: deploy
  uri: url="https://{{ staypuft.deploy.ip }}/deployments/{{ deployment_id.stdout }}/deploy"
       method=POST
       HEADER_Cookie="{{login.set_cookie}}"
       HEADER_X-CSRF-Token="{{ token.stdout }}"
       follow_redirects=safe
       status_code=302

