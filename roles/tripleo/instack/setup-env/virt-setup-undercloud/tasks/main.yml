---

- name: wait copy ssh keys
  shell: >
    chdir={{ jenkins.workspace }}/{{ jenkins.job_name }}
    sleep 5

- name: prep for copy ssh keys
  shell: sshpass -p {{ job_var.vm_pass }} ssh -o 'StrictHostKeyChecking=no' stack@{{ job_var.instack_virt_host }} -p {{ job_var.vm_ssh_port }} -v &

- name: set root password for vm
  shell: sshpass -p {{ job_var.vm_pass }} ssh -x -t -t -o 'StrictHostKeyChecking=no' stack@{{ job_var.instack_virt_host }} -p {{ job_var.vm_ssh_port }} 'export UNDERCLOUD_ROOT_PASSWORD=stack; echo $UNDERCLOUD_ROOT_PASSWORD | sudo passwd root --stdin'

- name: copy ssh keys
  shell: >
    chdir={{ jenkins.workspace }}/{{ jenkins.job_name }}
    sleep 5;
    sshpass -p {{ job_var.vm_pass }} ssh-copy-id -i {{ jenkins.workspace }}/{{ jenkins.job_name }}/{{ job_var.id_rsa_pub }}  stack@{{ job_var.instack_virt_host }} -p {{ job_var.vm_ssh_port }};
    sshpass -p {{ job_var.vm_pass }} ssh-copy-id -i {{ jenkins.workspace }}/{{ jenkins.job_name }}/{{ job_var.id_rsa_pub }} root@{{ job_var.instack_virt_host }} -p {{ job_var.vm_ssh_port }}

- name: add host with root user
  add_host: name={{ job_var.vm_ssh_port }} groups=instack-undercloud ansible_ssh_host={{ job_var.instack_virt_host }} ansible_ssh_port={{ job_var.vm_ssh_port }} ansible_ssh_user=root ansible_ssh_private_key_file={{ jenkins.workspace }}/{{ jenkins.job_name }}/{{ job_var.key_file }}

- name: add host with stack user
  add_host: name={{ job_var.vm_ssh_port }}-stack groups=instack-undercloud-stack ansible_ssh_host={{ job_var.instack_virt_host }} ansible_ssh_port={{ job_var.vm_ssh_port }} ansible_ssh_user=stack ansible_ssh_private_key_file={{ jenkins.workspace }}/{{ jenkins.job_name }}/{{ job_var.key_file }}

- name: ssh to host as root user
  shell: ssh -o 'StrictHostKeyChecking=no' root@{{ job_var.instack_virt_host }} -p {{ job_var.vm_ssh_port }} -i {{ jenkins.workspace }}/{{ jenkins.job_name }}/{{ job_var.key_file }}

- name: ssh to host as stack user
  shell: ssh -o 'StrictHostKeyChecking=no' stack@{{ job_var.instack_virt_host }} -p {{ job_var.vm_ssh_port }} -i {{ jenkins.workspace }}/{{ jenkins.job_name }}/{{ job_var.key_file }}
