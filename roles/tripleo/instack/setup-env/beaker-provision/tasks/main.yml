---
- name: check if beakerCheckOut.sh script exists
  stat: path="{{ jenkins.workspace }}/{{ jenkins.job_name }}/beakerCheckOut.sh"
  register: beakerCheckOut_present

- name: remove beakerCheckOut.sh script if it exists
  command: rm -rf {{ jenkins.workspace }}/{{ jenkins.job_name }}/beakerCheckOut.sh
  when: beakerCheckOut_present.stat.exists == True

- name: get beakerCheckOut.sh file from khaleesi-settings
  shell: >
    chdir={{ jenkins.workspace }}/{{ jenkins.job_name }}
    cp {{ jenkins.workspace }}/{{ jenkins.job_name }}/{{ provisioner.beaker_checkout_script }} .

- name: check if beakerCheckOut.sh script exists
  stat: path="{{ jenkins.workspace }}/{{ jenkins.job_name }}/beakerCheckOut.sh"
  register: beakerCheckOut_downloaded

- fail: msg="Cannot get {{ provisioner.beaker_checkout_script }}. Exiting with failure."
  when: beakerCheckOut_downloaded.stat.exists == False

- name: chmod if file exists
  shell: >
    chdir={{ jenkins.workspace }}/{{ jenkins.job_name }}
    chmod +x beakerCheckOut.sh
  when: beakerCheckOut_downloaded.stat.exists == True

- name: return the Beaker machine if it is checked out
  shell: sshpass -p {{ job_var.vm_pass }} ssh -x -l root {{ provisioner.machine_name }} "return2beaker.sh"
  ignore_errors: yes

- name: provision Beaker machine
  shell: >
    chdir={{ jenkins.workspace }}/{{ jenkins.job_name }}
    {{ jenkins.workspace }}/{{ jenkins.job_name }}/beakerCheckOut.sh --arch={{ provisioner.beaker_arch }} --family=Fedora20 --tag=RELEASED --hostrequire=hostlabcontroller={{ provisioner.host_lab_controller }} --username={{ provisioner.beaker_user_name }} --password={{ provisioner.beaker_password }} --task=/CoreOS/rhsm/Install/automatjon-keys --keyvalue=HVM=1  --ks_meta="ksdevice=link" --whiteboard={{ provisioner.whiteboard_message }} --job-group={{ provisioner.beaker_group }} --machine={{ provisioner.machine_name }} --timeout=720;
  register: beaker_job_status
  async: 7200
  poll: 180
  when: provisioner.beaker_password is defined

- name: provision Beaker machine
  shell: >
    chdir={{ jenkins.workspace }}/{{ jenkins.job_name }}
    {{ jenkins.workspace }}/{{ jenkins.job_name }}/beakerCheckOut.sh --arch={{ provisioner.beaker_arch }} --family=Fedora20 --tag=RELEASED --hostrequire=hostlabcontroller={{ provisioner.host_lab_controller }} --username={{ provisioner.beaker_user_name }} --task=/CoreOS/rhsm/Install/automatjon-keys --keyvalue=HVM=1  --ks_meta="ksdevice=link" --whiteboard={{ provisioner.whiteboard_message }} --job-group={{ provisioner.beaker_group }} --machine={{ provisioner.machine_name }} --timeout=720;
  register: beaker_job_status
  async: 7200
  poll: 180
  when: provisioner.beaker_password is not defined

