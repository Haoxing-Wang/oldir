---

- name: prepare for overcloud
  shell:
    "cd {{ instack_user_home.stdout }};
     export IMG_SOURCE_URL={{ image_src_dir }};
     instack-prepare-for-overcloud"

- name: copy template file with environment variables
  template:
    src=deployrc.j2
    dest={{ instack_user_home.stdout }}/deploy-overcloudrc
    mode=0755
  sudo_user: "{{ instack_user  }}"
  sudo: yes

- name: run script to deploy overcloud from packages
  shell:
    "cd {{ instack_user_home.stdout }};
     source {{ instack_user_home.stdout }}/deploy-overcloudrc;
     source {{ instack_user_home.stdout }}/tripleo-undercloud-passwords;
     instack-deploy-overcloud-tuskarcli"
  sudo_user: "{{ instack_user  }}"
  sudo: yes

