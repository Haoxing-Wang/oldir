---

- name: add export of LIVBIRT_DEFAULT_URI to bashrc file
  shell: "echo 'export LIBVIRT_DEFAULT_URI=\"qemu:///system\"' >> ~/.bashrc"
  sudo_user: "{{ instack_user }}"
  sudo: yes

- name: enable the rdo-release repository
  yum: name="{{ rdo[ config.version ].instack_release_rpm[ ansible_distribution ] }}" state=present #"
  when: ansible_distribution == 'Fedora' and config.custom_repo is not defined
  register: rdo_repo_output

- name: print rdo_repo_output
  debug: var=rdo_repo_output.stdout
  when: ansible_distribution == 'Fedora' and config.custom_repo is not defined

- name: enable a custom repository
  yum: name="{{ config.custom_repo }}"
  when: config.custom_repo is defined
  register: rdo_repo_output

- name: print rdo_repo_output
  debug: var=rdo_repo_output.stdout
  when: config.custom_repo is defined

- name: install instack-undercloud
  yum: name=instack-undercloud state=latest
  when: config.instack_undercloud_rpm is not defined
  register: instack_undercloud_output

- name: print instack_undercloud_output
  debug: var=instack_undercloud_output.stdout
  when: config.instack_undercloud_rpm is not defined

- name: install updated version of instack-undercloud if it exists
  yum: name="{{ config.instack_undercloud_rpm }}"
  when: config.instack_undercloud_rpm is defined
  register: instack_undercloud_output

- name: print instack_undercloud_output
  debug: var=instack_undercloud_output.stdout
  when: config.instack_undercloud_rpm is defined

- name: install updated version of other rpms if they exist
  yum: name={{ item }}
  with_items: config.updated_rpms_list
  when: config.updated_rpms_list is defined
  register: custom_rpm_output

- name: print custom_rpm_output
  debug: var=custom_rpm_output.stdout
  when: config.updated_rpms_list is defined

- name: install libguestfs-tools
  yum: name=libguestfs-tools

- name: install systemd
  yum: name=systemd

- name: run script to install required dependencies
  shell: "cd {{ instack_user_home.stdout }}; export LIBVIRT_DEFAULT_URI=\"qemu:///system\" ; source /usr/libexec/openstack-tripleo/devtest_variables.sh; tripleo install-dependencies"
  ignore_errors: yes
  sudo_user: "{{ instack_user }}"
  sudo: yes

- name: run script to setup virtual environment
  register: instack_virt_result
  shell: "cd {{ instack_user_home.stdout }}; export LIBVIRT_DEFAULT_URI=\"qemu:///system\" ; instack-virt-setup"
  sudo_user: "{{ instack_user }}"
  sudo: yes

- name: start instack vm
  shell: "export LIBVIRT_DEFAULT_URI=\"qemu:///system\" ; sleep 5; virsh list --all; virsh start instack"
  sudo_user: "{{ instack_user }}"
  sudo: yes

- name: get ip address of instack vm
  shell: "sleep 10; cat /var/lib/libvirt/dnsmasq/default.leases | grep $(tripleo get-vm-mac instack) | awk '{print $3;}'"
  register: instack_ip_address
  sudo_user: "{{ instack_user }}"
  sudo: yes

- name: print instack_ip_address
  debug: var=instack_ip_address.stdout

- name: get mac addresses for overcloud nodes
  shell: "for i in $(seq 0 3); do echo -n $(tripleo get-vm-mac baremetal_$i) \" \"; done; echo"
  register: overcloud_node_ips
  sudo_user: "{{ instack_user }}"
  sudo: yes

- name: print overcloud_node_ips
  debug: var=overcloud_node_ips.stdout
