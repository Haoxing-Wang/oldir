---

- name: install sshpass
  yum: name=sshpass state=present
  when: ansible_distribution == 'Fedora'
  sudo_user: root
  sudo: yes

- name: install sshpass for tunnel
  shell: >
    rpm -i {{ installer.rhel7.sshpass_rpm }}
  when: ansible_distribution == 'RedHat'
  ignore_errors: yes
  sudo_user: root
  sudo: yes

- name: disable require tty for remote access
  shell: "sed -i 's/Defaults    requiretty/#Defaults    requiretty/g' /etc/sudoers"
  sudo_user: root
  sudo: yes

- name: ssh to virt-host
  shell: >
    chdir={{ instack_user_home.stdout }}
    sshpass -p {{ instack.user.stack.password }} ssh -o 'StrictHostKeyChecking=no' {{ instack.user.stack.name }}@192.168.122.1 &

- name: install wget
  yum: name=wget state=present
  when: ansible_distribution == 'Fedora'
  sudo_user: root
  sudo: yes

- name: prepare for overcloud - download images
  shell: >
    chdir={{ instack_user_home.stdout }}
    export IMG_SOURCE_URL="{{ product.instack_images[ ansible_distribution ][ansible_distribution_version] }}";
    wget --no-verbose --no-parent --recursive --level=1 --no-directories $IMG_SOURCE_URL
  async: 18000
  poll: 300
  when: product.instack_images[ansible_distribution][ansible_distribution_version] is defined and installer.custom_instack_images is not defined
  register: instack-prepare-for-overcloud

- name: print instack-prepare-for-overcloud-output
  debug: var=instack-prepare-for-overcloud-output.stdout
  when: product.instack_images[ansible_distribution][ansible_distribution_version] is defined and installer.custom_instack_images is not defined

- name: prepare for overcloud with custom images
  shell: >
    chdir={{ instack_user_home.stdout }}
    export IMG_SOURCE_URL="{{ installer.custom_instack_images }}";
    wget --no-verbose --no-parent --recursive --level=1 --no-directories $IMG_SOURCE_URL
  async: 18000
  poll: 300
  when: installer.custom_instack_images is defined
  register: instack-prepare-for-overcloud-output

- name: print instack-prepare-for-overcloud-output
  debug: var=instack-prepare-for-overcloud-output.stdout
  when: installer.custom_instack_images is defined

- name: prepare for overcloud with built images
  shell: >
    chdir={{ instack_user_home.stdout }}
    sshpass -p stack scp -o 'StrictHostKeyChecking=no' {{ instack.user.stack.name }}@192.168.122.1:/home/stack/\{*.initramfs,*.kernel,*.qcow2,*.initrd,*.vmlinuz\} .
  when: product.instack_images[ansible_distribution][ansible_distribution_version] is not defined and installer.custom_instack_images is not defined

- include: ../../common-rpms/tasks/main.yml

# RHEL
- name: install instack-undercloud
  shell: >
    chdir={{ instack_user_home.stdout }}
    export RHOS=1;
    export NODE_DIST="rhel7";
    export DIB_YUM_REPO_CONF="/etc/yum.repos.d/rhos-release-6-rhel-7.0.repo";
    export REG_HALT_UNREGISTER=1
    export REG_METHOD=disable;
    sudo yum install -y instack-undercloud
  when: ansible_distribution == 'RedHat' and installer.instack_undercloud_rpm is not defined
  register: instack_undercloud_output

- name: install wget
  yum: name=wget state=present
  when: ansible_distribution == 'RedHat'
  sudo_user: root
  sudo: yes

- name: check answers file exists
  shell: "[ -e {{ instack_user_home.stdout }}/instack.answers ]"
  register: answers_file_present
  changed_when: false
  failed_when: false

- name: check if install undercloud has been run
  stat: path="{{ instack_user_home.stdout }}/.instack/install-undercloud.log"
  register: instack_log_present

# Fedora
- name: run script to install undercloud
  register: instack_undercloud_result
  command:  chdir={{ instack_user_home.stdout }} instack-install-undercloud
  when: ansible_distribution == 'Fedora' and instack_log_present.stat.exists == False

# RHEL
- name: install instack-undercloud
  shell: >
    chdir={{ instack_user_home.stdout }}
    export RHOS=1;
    export NODE_DIST="rhel7";
    export DIB_YUM_REPO_CONF="/etc/yum.repos.d/rhos-release-6-rhel-7.0.repo";
    export REG_HALT_UNREGISTER=1
    export REG_METHOD=disable;
    instack-install-undercloud
  when: ansible_distribution == 'RedHat' and instack_log_present.stat.exists == False
  register: instack_undercloud_rhel_result

- name: search output for complete status
  shell: "cat {{ instack_user_home.stdout }}/.instack/install-undercloud.log | grep 'install-undercloud complete'"
  register: grep_output

- name: report failure if install is not complete
  fail: msg="report error"
  when: grep_output.stdout == ""

- name: copy stackrc file
  shell: "cp /root/stackrc {{ instack_user_home.stdout }}"
  sudo_user: root
  sudo: yes

- name: copy tripleo-undercloud-passwords file
  shell: "cp /root/tripleo-undercloud-passwords {{ instack_user_home.stdout }}"
  sudo_user: root
  sudo: yes

