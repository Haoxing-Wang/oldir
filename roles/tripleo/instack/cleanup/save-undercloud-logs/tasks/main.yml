---

- name: save logs from undercloud
  shell: sshpass -p {{ job_var.vm_pass }} ssh -x -l stack {{ job_var.instack_virt_host }} "cd /home/stack; journalctl --full > journalctl.output; sudo tar -cvjf undercloud_logs.tar.bz2 /home/stack/.instack/install-undercloud.log /var/log/glance /var/log/heat /var/log/keystone /var/log/neutron /var/log/nova /var/log/openvswitch /var/log/os-apply-config.log /var/log/rabbitmq journalctl.output"
  when: instack.environ.name == 'baremetal'

- name: wait for tar to complete
  pause: seconds=10
  when: instack.environ.name == 'baremetal'

- name: copy tar file to running host
  shell: >
    sshpass -p {{ job_var.vm_pass }} scp -o 'StrictHostKeyChecking=no' stack@{{ job_var.instack_virt_host }}:/home/stack/undercloud_logs.tar.bz2 {{ jenkins.workspace }}/{{ jenkins.job_name }}/undercloud_logs.tar.bz2 &
  when: instack.environ.name == 'baremetal'

- name: save logs from undercloud
  shell: sshpass -p {{ job_var.vm_pass }} ssh -x -l stack {{ job_var.instack_virt_host }} -p {{ job_var.vm_ssh_port }} "cd /home/stack; journalctl --full > journalctl.output; sudo tar -cvjf undercloud_logs.tar.bz2 /home/stack/.instack/install-undercloud.log /var/log/glance /var/log/heat /var/log/keystone /var/log/neutron /var/log/nova /var/log/openvswitch /var/log/os-apply-config.log /var/log/rabbitmq journalctl.output"
  when: instack.environ.name == 'virt'

- name: wait for tar to complete
  pause: seconds=10
  when: instack.environ.name == 'virt'

- name: copy tar file to running host
  shell: >
    sshpass -p {{ job_var.vm_pass }} scp -o 'StrictHostKeyChecking=no' -P {{ job_var.vm_ssh_port }} stack@{{ job_var.instack_virt_host }}:/home/stack/undercloud_logs.tar.bz2 {{ jenkins.workspace }}/{{ jenkins.job_name }}/undercloud_logs.tar.bz2 &
  when: instack.environ.name == 'virt'




