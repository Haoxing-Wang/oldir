---

- name: check if tempest ran
  stat: path="{{ jenkins.workspace }}/{{ jenkins.job_name }}/khaleesi/playbooks/nosetests.xml"
  register: nosetests_xml_exists

- name: if tempest ran, install tar and bzip2
  shell: >
    sshpass -p {{ job_var.vm_pass }} ssh -o 'StrictHostKeyChecking=no' -x -l root {{ job_var.tempest_machine }} "yum install -y tar bzip2"
  when: nosetests_xml_exists.stat.exists == True and instack.environ.name == 'baremetal'

- name: if tempest ran, tar files
  shell: >
    sshpass -p {{ job_var.vm_pass }} ssh -o 'StrictHostKeyChecking=no' -x -l root {{ job_var.tempest_machine }} "cd /root; tar -cvjf tempest_logs.tar.bz2 '{{ tempest.dir }}/etc/tempest.conf' '{{ tempest.dir }}/etc/tempest.conf.sample' '{{ tempest.dir }}/*.log' '{{ tempest.dir }}/*.xml'"
  when: nosetests_xml_exists.stat.exists == True and instack.environ.name == 'baremetal'

- name: wait for tar to complete
  pause: seconds=10
  when: nosetests_xml_exists.stat.exists == True and instack.environ.name == 'baremetal'

- name: if tempest ran, copy files
  shell: >
    sshpass -p {{ job_var.vm_pass }} scp -o 'StrictHostKeyChecking=no' root@{{ job_var.tempest_machine }}:/root/tempest_logs.tar.bz2 {{ jenkins.workspace }}/{{ jenkins.job_name }}/tempest_logs.tar.bz2 &
  when: nosetests_xml_exists.stat.exists == True and instack.environ.name == 'baremetal'

- name: if tempest ran, install tar and bzip2
  shell: >
    sshpass -p {{ job_var.vm_pass }} ssh -x -l root {{ job_var.instack_virt_host }} -p {{ job_var.tempest_machine_port }} "yum install -y tar bzip2"
  when: nosetests_xml_exists.stat.exists == True and instack.environ.name == 'virt'

- name: if tempest ran, tar files
  shell: >
    sshpass -p {{ job_var.vm_pass }} ssh -x -l root {{ job_var.instack_virt_host }} -p {{ job_var.tempest_machine_port }} "cd /root; tar -cvjf tempest_logs.tar.bz2 '{{ tempest.dir }}/etc/tempest.conf' '{{ tempest.dir }}/etc/tempest.conf.sample' '{{ tempest.dir }}/*.log' '{{ tempest.dir }}/*.xml'"
  when: nosetests_xml_exists.stat.exists == True and instack.environ.name == 'virt'

- name: wait for tar to complete
  pause: seconds=10
  when: nosetests_xml_exists.stat.exists == True and instack.environ.name == 'virt'

- name: if tempest ran, copy files
  shell: >
    sshpass -p {{ job_var.vm_pass }} scp -o 'StrictHostKeyChecking=no' -P {{ job_var.vm_ssh_port }} root@{{ job_var.tempest_machine }}:/root/tempest_logs.tar.bz2 {{ jenkins.workspace }}/{{ jenkins.job_name }}/tempest_logs.tar.bz2 &
  when: nosetests_xml_exists.stat.exists == True and instack.environ.name == 'virt'

- name: save dummy file if tempest didn't run
  shell: >
    echo 'empty file' > {{ jenkins.workspace }}/{{ jenkins.job_name }}/khaleesi/playbooks/nosetests.xml
  when: nosetests_xml_exists.stat.exists == False
