---
- name: get instack-set-host-rhel7 script
  get_url: url=https://raw.githubusercontent.com/rdo-management/instack-undercloud/master/scripts/instack-setup-host-rhel7
                dest={{ instack_user_home }}
                validate_certs=no
                timeout=30

- name: run instack-setup-host-rhel7 script
  shell: >
    bash -x instack-setup-host-rhel7

- name: install instack-undercloud
  yum: name=instack-undercloud state=latest
  sudo: yes

#synchronize does not pass the ssh config to rysync, local_action required
- name: copy the repo from jenkins with the gerrit changeset when gating
  local_action: command rsync -avz -e "ssh -F {{ lookup('env', 'WORKSPACE') }}/khaleesi/ssh.config.ansible" {{ lookup('env', 'WORKSPACE') }}/instack-undercloud undercloud:{{ instack_user_home }} --delete
  when: "\"rdo-management/instack-undercloud\" == \"{{ lookup('env', 'GERRIT_PROJECT') }}\""

- name: install the undercloud
  command: instack-install-undercloud

- name: copy files to home
  sudo: yes
  command: cp /root/{{ item }} {{ instack_user_home }}/{{ item }}
  with_items:
    - tripleo-undercloud-passwords
    - stackrc

- name: chown files for stack user
  sudo: yes
  command: chown stack:stack {{ instack_user_home }}/{{ item }}
  with_items:
    - tripleo-undercloud-passwords
    - stackrc

- name: get the rhel-guest-image
  get_url: url={{ distro.images['rhel'][ansible_distribution_version].remote_file_server }}{{ distro.images['rhel'][ansible_distribution_version].guest_image_name }}
                dest={{ instack_user_home }}
