---
- name: get instack-set-host-rhel7 script
  get_url: url=https://raw.githubusercontent.com/rdo-management/instack-undercloud/master/scripts/instack-setup-host-rhel7
                  dest={{ instack_user_home }}

- name: run instack-setup-host-rhel7 script
  shell: >
    bash -x instack-setup-host-rhel7

- name: install instack-undercloud
  yum: name=instack-undercloud state=latest
  sudo: yes

- name: copy the repo from jenkins with the gerrit changeset when gating
  synchronize: src={{ lookup('env', 'WORKSPACE') }}/instack-undercloud dest={{ instack_user_home }} recursive=yes delete=yes
  when: "\"rdo-management/instack-undercloud\" == \"{{ lookup('env', 'GERRIT_PROJECT') }}\""

- name: get the guest-image
  get_url: url={{ distro.images[distro.name][ansible_distribution_version].remote_file_server }}{{ distro.images[distro.name][ansible_distribution_version].guest_image_name }}
                dest={{ instack_user_home }}

- name: destroy virbr0 network if present
  command: brctl delbr virbr0
  ignore_errors: true

#see https://review.gerrithub.io/#/c/217853/
- name: run instack-virt-setup
  register: instack_virt_setup_result
  ignore_errors: yes
  shell: >
    export DIB_LOCAL_IMAGE={{ distro.images[distro.name][ansible_distribution_version].guest_image_name }}
    export DIB_YUM_REPO_CONF=/etc/yum.repos.d/rhos-release-6-rhel-7.1.repo;
    export NODE_DIST=rhel7;
    instack-virt-setup;

- name: update libvirtd unix_sock_group
  sudo: yes
  lineinfile: dest=/etc/libvirt/libvirtd.conf
                  regexp=^unix_sock_group
                  line='unix_sock_group = "stack"'

- name: restart libvirtd
  service: name=libvirtd state=restarted
  sudo: yes

- name: inspect virsh capabilities
  command: 'virsh capabilities'
  sudo: yes

# workaround for the SATA error RHBZ#1195882
- name: remove libvirt qemu capabilities cache
  command:  rm -Rf  /var/cache/libvirt/qemu/capabilities/
  sudo: yes
  when: "instack_virt_setup_result.rc != 0"

# workaround for the SATA error RHBZ#1195882
- name: restart libvirtd
  service: name=libvirtd state=restarted
  sudo: yes
  when: "instack_virt_setup_result.rc != 0"

- name: inspect virsh capabilities
  command: 'virsh capabilities'
  when: "instack_virt_setup_result.rc != 0"

- name: retry run instack-virt-setup
  shell: >
    virsh undefine instack;
    export DIB_LOCAL_IMAGE={{ distro.images[distro.name][ansible_distribution_version].guest_image_name }}
    export DIB_YUM_REPO_CONF=/etc/yum.repos.d/rhos-release-6-rhel-7.1.repo;
    export NODE_DIST=rhel7;
    instack-virt-setup;
  when: "instack_virt_setup_result.rc != 0"

- name: print out all the VMs
  shell: >
    sudo virsh list --all
