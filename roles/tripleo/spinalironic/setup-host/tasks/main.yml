---

- name: add export of LIVBIRT_DEFAULT_URI to bashrc file
  shell: "echo 'export LIBVIRT_DEFAULT_URI=\"qemu:///system\"' >> ~/.bashrc"

- name: cleanup a possible previous run
  shell: >
    rm -f ~/instack*qcow2

- name: get instack-set-host-rhel7 script
  get_url: url=https://raw.githubusercontent.com/rdo-management/instack-undercloud/master/scripts/instack-setup-host-rhel7 dest={{ instack_user_home.stdout }}

- name: run instack-setup-host-rhel7 script
  shell: >
    export RUN_RHOS_RELEASE=0;
    bash -x instack-setup-host-rhel7

- name: copy the repo from jenkins with the gerrit changeset when gating
  synchronize: src=instack-undercloud dest={{ instack_user_home.stdout }} recursive=yes delete=yes
  when: "\"rdo-management/instack-undercloud\" == \"{{ lookup('env', 'GERRIT_PROJECT') }}\""

# we need to ignore the last command's 1 output because it's a bad hack
- name: run script to install required dependencies
  shell: >
    source /usr/libexec/openstack-tripleo/devtest_variables.sh;
    tripleo install-dependencies;
    tripleo set-usergroup-membership;
    if [ $? -gt 1 ]; then /bin/false; fi

- name: get the rhel-guest-image
  get_url: url={{ product.images['rhel'][ansible_distribution_version].remote_file_server }}{{ product.images['rhel'][ansible_distribution_version].guest_image_name }} dest={{ instack_user_home.stdout }}

- name: run instack-virt-setup
  shell: >
    chdir={{ instack_user_home.stdout }}
    source instack-undercloud/rhel7rc;
    export DIB_LOCAL_IMAGE={{ product.images['rhel'][ansible_distribution_version].guest_image_name }};
    export DIB_YUM_REPO_CONF=/etc/yum.repos.d/rhos-release-6-rhel-{{ ansible_distribution_version }}.repo;
    export NODE_DIST=rhel7;
    instack-undercloud/scripts/instack-virt-setup;

