- name: install test dependencies rpm needed to run test
  sudo: yes
  yum: pkg={{ item }} state=latest
  with_items: test_cfg.setup.install
  when:
    test_cfg.setup | default(false) and test_cfg.setup.install | default(false)

- name: remove unwanted rpms specified in test dependencies
  sudo: yes
  yum: pkg={{ item }} state=absent
  with_items: test_cfg.setup.remove
  when:
    test_cfg.setup | default(false) and test_cfg.setup.remove | default(false)

### actual testrun starts here
- name: print the test setup  command
  debug: var=test_cfg

- name: Run unit test ...
  shell: >
    {{ test_cfg.run.replace('\n', '') }}
  args:
    chdir: "{{ component_path }}"
    executable: /bin/bash
  register: unit_test_run
  ignore_errors: true
  when: tester.name == 'unittest'

- name: Run pep8 test ...
  shell: >
    {{ test_cfg.run_pep8.replace('\n', '') }}
  args:
    chdir: "{{ component_path }}"
    executable: /bin/bash
  register: pep8_test_run
  ignore_errors: true
  when: tester.name == 'pep8'

- name: print out pep8 test run
  debug: var=pep8_test_run
  when: pep8_test_run is defined

- name: print out unit test run
  debug: var=unit_test_run
  when: unit_test_run is defined

- name: copy test results to logs dir
  fetch: src="{{ component_path }}/{{ item }}"
         dest=../../../../logs/ flat=yes
  with_items: test_cfg.archive

- name: pass or fail the test
  fail: msg="The test run failed"
  when: ((pep8_test_run is defined and pep8_test_run.rc !=0) or (unit_test_run is defined and unit_test_run.rc !=0))


