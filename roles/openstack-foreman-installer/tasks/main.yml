---
- name: Add RDO/RHOS repos
  yum: name={{ openstack_foreman_installer_repo_rpm }}

- name: Install openstack-foreman-installer rpm
  yum: name=openstack-foreman-installer state=present

- name: Make /etc/hosts proper
  lineinfile: dest=/etc/hosts regexp='.*{{item}}$' line='${hostvars.${item}.ansible_eth1.ipv4.address} ${item}' state=present
  with_items: '{{groups.foreman}}'

- name: Deactivate iptables
  service: name=iptables enabled=no state=stopped

- name: Specify foreman environment
  template: src=foreman_env.j2 dest=/tmp/foreman_env mode=0644

- name: Check for SecureRandom
  shell: grep 'SecureRandom.hex' /usr/share/openstack-foreman-installer/bin/seeds.rb
  ignore_errors: True
  register: random_passwords

- name: Make passwords the same for foreman environment
  shell: "/bin/sed -i -e 's/SecureRandom.hex/\"redhat\"/' {{ item }}"
  with_items: '/usr/share/openstack-foreman-installer/bin/seeds.rb'
  when: random_passwords.rc == 0

- name: Remove the prompt in foreman_server.sh
  lineinfile: dest=/usr/share/openstack-foreman-installer/bin/foreman_server.sh
              regexp='^read .*'
              state=absent

- name: Run the installer
  shell: chdir=/usr/share/openstack-foreman-installer/bin
         creates=/tmp/foreman_client.sh
         source /tmp/foreman_env && bash -x ./foreman_server.sh

- name: Put the client installer into foreman public dir
  action: command /bin/cp /tmp/foreman_client.sh /var/lib/foreman/public

- name: Set the perms on foreman_client
  file: path=/var/lib/foreman/public/foreman_client.sh owner=foreman group=foreman state=file