---
- name: Make /etc/hosts proper
  lineinfile: dest=/etc/hosts regexp='.*{{item}}$' line='${hostvars.${item}.ansible_eth1.ipv4.address} ${item}' state=present
  with_items: '{{ groups.foreman_installer }}'

# Using copy then shell instead of script directly, since script does not support create
- name: Copy the client script
  copy: src=/tmp/foreman/foreman_client.sh dest=/tmp/foreman_client.sh mode=0755

- name: Register this host with foreman
  action: shell /tmp/foreman_client.sh
        creates=/var/lib/puppet/ssl/certs/{{ inventory_hostname }}.pem

- name: Pause because puppet does not exit as quickly as it should
  pause: seconds=5

- name: Stop the puppet service
  service: name=puppet state=stopped

- name: Get {{ foreman_node_hostgroup }} hostgroup
  action: >
        uri url=https://foreman.example.com/api/hostgroups?search=name=\"{{ foreman_node_hostgroup_param }}\"
        method=GET
        user=admin
        password=changeme
        force_basic_auth=yes
        return_content=yes
        HEADER_Content-Type="application/json"
        HEADER_Accepts="application/json"
  register: hostgroup_json

- name: Get the host back from foreman
  action: >
        uri url=https://foreman.example.com/api/hosts?search=name=\"{{ inventory_hostname }}\"
        method=GET
        user=admin
        password=changeme
        force_basic_auth=yes
        return_content=yes
        HEADER_Content-Type="application/json"
        HEADER_Accepts="application/json"
  register: host_json

- name: Set the hostgroup
  action: >
        uri url=https://foreman.example.com/api/hosts/{{host_json.json[0].host.id}}
        body='{"host": {"id": "{{ host_json.json[0].host.id }}", "hostgroup_id": "{{ hostgroup_json.json[0].hostgroup.id }}"}}'
        method=PUT
        user=admin
        password=changeme
        force_basic_auth=yes
        return_content=yes
        HEADER_Content-Type="application/json"
        HEADER_Accepts="application/json"

- name: Apply {{ foreman_node_hostgroup }} via puppet
  action: command /usr/bin/puppet agent --onetime --verbose --ignorecache --no-daemonize --no-usecacheonfailure --no-splay --show_diff
