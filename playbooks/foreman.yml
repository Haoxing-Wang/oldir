---
#determine provisioner and whether or not to skip
- include: group_by_provision.yml

- include: provision.yml
- include: validate_nodes.yml
- include: group_by.yml tags=groupby

- include: prep.yml

- name: Prepare for install - RDO common
  hosts: foreman_installer:&rdo
  sudo: yes
  roles:
    - { role: product/rdo/common }
  tags:
    - prep

- name: Prepare for install - RDO - RHEL and CentOS
  hosts: foreman_installer:RedHat:CentOS:!Fedora:&rdo
  sudo: yes
  roles:
    - { role: product/rdo/rhel }
  tags:
    - prep

- name: Prepare for install - RDO - Fedora
  hosts: foreman_installer:&Fedora:&rdo
  roles:
    - { role: product/rdo/fedora }
  tags:
    - prep

- name: Prepare for Foreman install
  hosts: foreman_installer
  sudo: yes
  roles:
    - { role: foreman/common }
  tags:
    - prep

- name: Prepare foreman network
  hosts: foreman_installer:tester
  sudo: yes
  roles:
    - { role: network-setup }
  tags:
    - prep
    - tempest_setup

# apply pre-foreman workarouds
- include: ../workarounds/workarounds-prep.yml tags=workaround

- name: setup virtual ips
  hosts: local
  roles:
    - { role: foreman/vip-setup }

- name: Install Foreman
  hosts: foreman
  gather_facts: True
  sudo: yes
  roles:
    - { role: foreman/openstack-installer }
    - { role: foreman/hostgroup-params }
  tags:
    - install

- name: set up foreman nfs shares
  hosts: foreman:&RedHat-7
  sudo: yes
  roles:
   - { role: foreman/nfs_server }
  tags:
   - install

- include: ../workarounds/workarounds-pre-run-foreman.yml tags=workaround

- name: Install Controller node
  hosts: controller
  gather_facts: True
  sudo: yes
  roles:
    - { role: foreman/openstack-node-common }
    - { role: foreman/openstack-node }
    - { role: workarounds/glance-table-utf8,
         tags: workaround,
         when: workaround_glance_table_utf8 is defined
               and workaround_glance_table_utf8
      }
  tags:
    - install_nodes

- name: Install remaining OpenStack nodes
  hosts: foreman_node:!controller
  gather_facts: True
  sudo: yes
  roles:
    - { role: foreman/openstack-node-common }
    - { role: foreman/openstack-node }
  tags:
    - install_nodes

#- include: ../workarounds/workarounds-post-run-foreman.yml tags=workaround

- name: Create Keystone RC files and OpenStack Status
  hosts: foreman_node
  sudo: yes
  roles:
    - { role: openstack/create-keystonerc }
  tags:
    - keystonerc

#- name: Openstack status
#  hosts: controller
#  sudo: yes
#  roles:
#    - { role: openstack/openstack-status }
#  tags:
#    - openstack-status

- name: Create external network
  hosts: controller
  roles:
    - { role: openstack/create-external-network }

- name: Create external network - HA configuration
  hosts: controller01
  roles:
    - { role: openstack/create-external-network }

- include: tempest.yml

- name: Get build details
  hosts: controller
  sudo: no
  roles:
    - { role: build_mark/build }

- name: Search for possible problems happened.
  hosts: all:!localhost:!tester
  sudo: yes
  roles:
    - { role: build_mark/search_problems }
  tags: provision

- name: Produce build marks summaries
  hosts: localhost
  roles:
    - { role: build_mark/summary }
  tags: provision
