---
# determine provisioner and whether or not to skip
- include: ../group_by_provision.yml

# provision
- include: beaker-provision.yml

- name: Create instack user {{ instack.user.stack.name }}
  hosts: instack-virt-host
  vars:
    - ansible_ssh_user: root
  roles:
      - tripleo/instack_user

- name: setup the virt-host
  hosts: instack-virt-host
  roles:
    - tripleo/spinalironic/setup-host
    - { role: tripleo/spinalironic/gate-instack-undercloud,
        when: "\"rdo-management/instack-undercloud\" == \"{{ lookup('env', 'GERRIT_PROJECT') }}\"" }
    - tripleo/spinalironic/virt-setup
    - tripleo/define-env/add-tripleo-hosts

- name: verify ssh connection
  hosts: all:!localhost
  roles:
    - tripleo/define-env/verify-ssh

- name: Get build details
  hosts: instack-virt-host
  sudo: yes
  roles:
    - build_mark/build

- name: install the undercloud
  hosts: undercloud
  roles:
    - tripleo/spinalironic/setup-host
    - { role: tripleo/spinalironic/gate-instack-undercloud,
        when: "\"rdo-management/instack-undercloud\" == \"{{ lookup('env', 'GERRIT_PROJECT') }}\"" }
    - tripleo/spinalironic/install-undercloud

- name: build the openstack-images
  hosts: undercloud
  roles:
   - { role: tripleo/spinalironic/build-images,
        when: "\"rdo-management/instack-undercloud\" == \"{{ lookup('env', 'GERRIT_PROJECT') }}\"" }

- name: import instack images
  hosts: undercloud
  roles:
  - { role: tripleo/spinalironic/import-images,
       when: "\"rdo-management/instack-undercloud\" != \"{{ lookup('env', 'GERRIT_PROJECT') }}\"" }

- name: deploy the nodes
  hosts: undercloud
  roles:
   - tripleo/spinalironic/deploy-nodes

- name: deploy the nodes
  hosts: undercloud
  roles:
   - tripleo/spinalironic/instack-deploy-overcloud

#test-overcloud is not working at the moment
# - name: test overcloud with built in script
#   hosts: undercloud
#   roles:
#     - role: tripleo/spinalironic/test-overcloud

#- include: spinalironic-tempest.yml

- name: Gather Logs
  hosts: all:!localhost
  sudo: yes
  roles:
    - collect_logs
