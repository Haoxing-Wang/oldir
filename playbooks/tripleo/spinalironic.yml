---
#determine provisioner and whether or not to skip
- include: ../group_by_provision.yml

# provision
- include: beaker-provision.yml

- name: Create instack user {{ instack.user.stack.name }}
  hosts: instack-virt-host
  vars:
    - ansible_ssh_user: root
  roles:
      - tripleo/instack_user

- name: setup the virt-host
  hosts: instack-virt-host
  roles:
    - { role: tripleo/spinalironic/setup-host }
    - { role: tripleo/define-env/add-tripleo-hosts }

- name: verify ssh connection
  hosts: all:!localhost
  roles:
    - { role: tripleo/define-env/verify-ssh }

- name: Get build details
  hosts: instack-virt-host
  sudo: yes
  roles:
    - { role: build_mark/build }

- name: install the undercloud
  hosts: undercloud
  roles:
   - { role: tripleo/spinalironic/install-undercloud }

- name: build the openstack-full image on the undercloud VM
  hosts: undercloud
  roles:
   - { role: tripleo/spinalironic/build-openstack-full }

- name: deploy the nodes
  hosts: undercloud
  roles:
   - { role: tripleo/spinalironic/deploy-nodes }

- name: Gather Logs
  hosts: all:!localhost
  sudo: yes
  roles:
    - { role: collect_logs }
