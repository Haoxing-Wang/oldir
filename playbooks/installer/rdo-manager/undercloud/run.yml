---
- name: install the undercloud
  hosts: undercloud
  tasks:
    - name: update hosts file for localhost.localhost (workaround for puppet, discovered on centos7)
      lineinfile: dest=/etc/hosts line="127.0.0.1   localhost localhost.localhost"
      sudo: yes

    - name: install the undercloud
      shell: openstack undercloud install --debug &> {{ instack_user_home }}/undercloud_install_initial_install.log

    - name: copy files to home
      sudo: yes
      command: cp /root/{{ item }} {{ instack_user_home }}/{{ item }}
      with_items:
        - tripleo-undercloud-passwords
        - stackrc

    - name: chown files for stack user
      sudo: yes
      command: chown stack:stack {{ instack_user_home }}/{{ item }}
      with_items:
        - tripleo-undercloud-passwords
        - stackrc

- name: confirm installing the undercloud is idempotent
  hosts: undercloud
  tasks:
    - name: install the undercloud
      shell: openstack undercloud install &> {{ instack_user_home }}/undercloud_install_idempotent_check.log

