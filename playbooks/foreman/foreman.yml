---
- name: Get nodes from nova
  hosts: local
  gather_facts: False
  roles:
    - { role: get_nodes, nodes: '{{ foreman_nodes }}' }
  tags:
    - provision

- name: Set facts for hosts
  hosts: foreman_installer
  gather_facts: False
  roles:
    - { role: set_facts }
    - { role: wait_for_hosts }
  tags:
    - provision

- name: Prepare for Foreman install
  hosts: foreman_installer
  user: "{{ remote_user }}"
  sudo: yes
  roles:
    - { role: common }
    - { role: linux-common }
    - { role: foreman/foreman-common }
    - { role: foreman/foreman-network-setup }
  tags:
    - prep

- name: Install Foreman
  hosts: foreman
  user: "{{ remote_user }}"
  sudo: yes
  roles:
    - { role: foreman/foreman-openstack-installer }
  tags:
    - install

- name: Install OpenStack nodes
  hosts: foreman_node
  user: "{{ remote_user }}"
  sudo: yes
  roles:
    - { role: foreman/foreman-openstack-node-common }
    - { role: foreman/foreman-openstack-node,
        foreman_node_hostgroup: Controller (Neutron),
        when: "'controller' in group_names",
        tags: ['controller'] }
    - { role: foreman/foreman-openstack-node,
        foreman_node_hostgroup: Controller (Nova Network),
        when: "'controller_nova' in group_names",
        tags: ['controller_nova'] }
    - { role: foreman/foreman-openstack-node,
        foreman_node_hostgroup: Compute (Neutron),
        when: "'compute' in group_names",
        tags: ['compute'] }
    - { role: foreman/foreman-openstack-node,
        foreman_node_hostgroup: Compute (Nova Network),
        when: "'compute_nova' in group_names",
        tags: ['compute_nova'] }
    - { role: foreman/foreman-openstack-node,
        foreman_node_hostgroup: Neutron Networker,
        when: "'networker' in group_names",
        tags: ['networker'] }
    - { role: foreman/foreman-openstack-node,
        foreman_node_hostgroup: Gluster Storage,
        when: "'gluster_storage' in group_names",
        tags: ['gluster_storage'] }
    - { role: foreman/foreman-openstack-node,
        foreman_node_hostgroup: LVM Block Storage,
        when: "'lvm_storage' in group_names",
        tags: ['lvm_storage'] }
    - { role: foreman/foreman-openstack-node,
        foreman_node_hostgroup: Load Balancer,
        when: "'load_balancer' in group_names",
        tags: ['load_balancer'] }
    - { role: foreman/foreman-openstack-node,
        foreman_node_hostgroup: HA Mysql Node,
        when: "'ha_mysql' in group_names",
        tags: ['ha_mysql'] }
    - { role: foreman/foreman-openstack-createrc,
        tags: ['keystonerc'] }

- name: Run tempest
  hosts: tempest
  user: "{{ remote_user }}"
  sudo: yes
  roles:
    - { role: tempest }
  tags:
    - tempest