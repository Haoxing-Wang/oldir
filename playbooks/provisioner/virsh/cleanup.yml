---
- name: Remove all VMs and networks that were created
  hosts: virthost
  gather_facts: no
  tasks:
      - name: get the list of VMs
        shell: "virsh list --all | grep -P '[\\w]+' | sed -n '2,$p' | awk '{print $2}'"
        register: vm_names

      - set_fact:
            vm_name_list: "{{ vm_names.stdout_lines }}"

      - name: stop relevant vms
        virt:
            name: "{{ item }}"
            state: destroyed
        with_items: vm_name_list

      - name: undefine relevant VMs
        virt:
            name: "{{ item }}"
            command: undefine
        with_items: vm_name_list

      - name: remove the networks we created
        virt_net:
            name: "{{ item.value.name }}"
            state: absent
        with_dict: provisioner.network.network_list
