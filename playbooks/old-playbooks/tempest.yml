---
- name: Gather facts from controller and compute
  hosts: all:!localhost:!tester
  sudo: yes
  tags:
    - tempest_setup
    - tempest_run

- name: tempest | Workaround | config_tempest.py | create openstack resources
  hosts: controller
  sudo: yes
  tags:
    - workaround
    - workaround-tempest-config-tool
  vars:
      apply_patch: workaround_config_tempest_tool|default(false)
  tasks:
      - script: ../workarounds/tempest/setup_openstack_env.sh
        when: apply_patch


- name: Create keystonerc
  hosts: tester:!skip_tempest_setup
  tags: tempest_setup
  roles:
    - { role: openstack/create-keystonerc }

- name: Update RPMs on tempest node
  hosts: tester:!skip_rdoupdate_tempest
  sudo: yes
  roles:
    - { role: rdopkg/prep, when: rdopkg_is_tempest_update is defined, tags: ["rdoupdate_tempest"] }

- name: Setup tempest and install packages for tempest
  hosts: tester:!skip_tempest_setup
  tags: tempest_setup
  roles:
    - { role: tempest/package-dependencies, sudo: yes }

- name: Update RPMs on tempest node
  hosts: tester:!skip_rdoupdate_tempest
  sudo: yes
  roles:
    - { role: rdopkg/preinstall, when: rdopkg_is_tempest_update is defined, tags: ["rdoupdate_tempest"] }

- name: Setup tempest and install packages for tempest
  hosts: tester:!skip_tempest_setup
  tags: tempest_setup
  roles:
    - { role: tempest/setup-openstack-elements, when: product.version == "havana" or product.version == "4.0"}
#    - { role: openstack/create-external-network }
    - { role: tempest/download-cirros }
    - { role: tempest/setup }
    - { role: tempest/security-groups }

- name: Run tempest
  hosts: tester
  tags: tempest_run
  roles:
    - { role: tempest/run }

