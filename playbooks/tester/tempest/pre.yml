---
- include: pre-{{ tester.setup }}.yml

- name: Configure tempest
  hosts: tester
  sudo: yes
  tasks:
    - name: Create a command to use tempest with venv
      copy:
        dest: "/home/{{ hostvars[inventory_hostname].ansible_ssh_user }}/{{ tester.dir }}/with_venv"
        mode: 0755
        content: |
          #!/bin/bash
          [[ -d $(dirname $0)/.venv ]] && source $(dirname $0)/.venv/bin/activate
          exec "$@"
    # FIXME: use non-root user (and HOME path) for configure-tempest.sh,
    #        after tempest.rpm ships and reads /etc/tempest or ~/tempest.conf (or something in that style)
    - template: dest=/root/configure-tempest.sh src=../templates/configure-tempest.j2 owner=root group=root mode=0755
      register: config_script

    - name: Configure tempest
      command: "/root/configure-tempest.sh"
      when: config_script|changed

    - name: Run testr init
      command: "./with_venv testr init"
      args:
        chdir: "/home/{{ hostvars[inventory_hostname].ansible_ssh_user }}/{{ tester.dir }}"
        creates: .testrepository

