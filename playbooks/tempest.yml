---
- name: Gather facts from all hosts for tempest
  hosts: all:!localhost:!tempest
  tasks:
    - setup: 
  tags:
    - tempest_setup
    - tempest_run

- name: Gather facts of tempest node
  hosts: tempest
  tasks:
    - setup: 
  user: "{{ tempest_remote_user }}"
  tags:
    - tempest_setup

- name: Ensure iptables is open for tempest
  hosts: all:!localhost:!tempest
  user: "{{ remote_user }}"
  roles:
    - { role: tempest/iptables }
  tags:
    - tempest_setup

- name: Create keystonerc and install packages for tempest
  hosts: tempest
  user: "{{ tempest_remote_user }}"
  roles:
    - { role: openstack/create-keystonerc }
  tags:
    - tempest_setup

- name: Setup tempest
  hosts: tempest
  user: "{{ tempest_remote_user }}"
  roles:
    - { role: packstack/rdo/fedora }
    - { role: tempest/package-dependencies }
    - { role: tempest/setup-openstack-elements }
  tags:
    - tempest_setup

- name: Run tempest
  hosts: tempest
  user: "{{ tempest_remote_user }}"
  roles:
    - { role: tempest, controller_fqdn: "{{ controller_name }}", tags: ["tempest_run"] }
